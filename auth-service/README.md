# Servicio de Autenticaci√≥n - FastAPI

Microservicio independiente de autenticaci√≥n implementado con FastAPI que maneja registro, login, verificaci√≥n de tokens JWT y gesti√≥n de usuarios.

## Especificaci√≥n del API REST

El servicio implementa los siguientes endpoints seg√∫n la especificaci√≥n oficial:

| Endpoint | M√©todo | Descripci√≥n | Autenticaci√≥n | Notas |
|----------|--------|-------------|---------------|-------|
| `/api/auth/signup` | POST | Registro de nuevos usuarios en la plataforma | No | Valida email √∫nico y confirmaci√≥n de contrase√±a |
| `/api/auth/login` | POST | Autenticaci√≥n de usuarios y generaci√≥n de token JWT | No | Devuelve token JWT v√°lido para autenticaci√≥n posterior |

## Caracter√≠sticas

- üîê Autenticaci√≥n JWT con tokens seguros
- üë§ Registro y gesti√≥n de usuarios
- üîí Verificaci√≥n de tokens para otros servicios
- üöÄ API RESTful con FastAPI
- üê≥ Contenedorizado con Docker
- üìö Documentaci√≥n autom√°tica con Swagger/OpenAPI

## Estructura del Proyecto

```
auth-service/
‚îú‚îÄ‚îÄ main.py                 # Aplicaci√≥n principal FastAPI
‚îú‚îÄ‚îÄ requirements.txt        # Dependencias Python
‚îú‚îÄ‚îÄ Dockerfile             # Imagen Docker
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ user.py            # Modelos Pydantic para usuarios
‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth.py            # Endpoints de autenticaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ users.py           # Endpoints de usuarios
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py    # L√≥gica de negocio de auth
‚îÇ   ‚îî‚îÄ‚îÄ jwt_service.py     # Manejo de tokens JWT
‚îî‚îÄ‚îÄ middleware/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ auth_middleware.py  # Middleware de autenticaci√≥n
```

## Endpoints Disponibles

### Autenticaci√≥n
- `POST /auth/register` - Registrar nuevo usuario
- `POST /auth/login` - Iniciar sesi√≥n
- `POST /auth/verify-token` - Verificar token JWT
- `POST /auth/refresh-token` - Renovar token JWT

### Usuarios
- `GET /users/me` - Obtener perfil del usuario actual
- `GET /users/{user_id}` - Obtener usuario por ID

### Sistema
- `GET /` - Informaci√≥n del servicio
- `GET /health` - Health check

## Uso

### 1. Registro de Usuario (Signup)

```bash
curl -X POST "http://localhost:8001/api/auth/signup" \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "John",
    "last_name": "Doe",
    "email": "john@example.com",
    "password1": "StrongPass123",
    "password2": "StrongPass123",
    "city": "Bogot√°",
    "country": "Colombia"
  }'
```

Respuesta (HTTP 201):
```json
{
  "id": 1,
  "email": "john@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "city": "Bogot√°",
  "country": "Colombia",
  "is_active": true,
  "created_at": "2025-10-11T15:30:00.123456",
  "updated_at": null
}
```

### C√≥digos de Respuesta para Registro:
- **201**: Usuario creado exitosamente
- **400**: Error de validaci√≥n (email duplicado, contrase√±as no coinciden)

### 2. Iniciar Sesi√≥n (Login)

```bash
curl -X POST "http://localhost:8001/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "StrongPass123"
  }'
```

Respuesta exitosa (HTTP 200):
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGci...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

### C√≥digos de Respuesta para Login:
- **200**: Autenticaci√≥n exitosa, retorna token JWT
- **401**: Credenciales incorrectas (email no existe o contrase√±a incorrecta)

### 3. Usar Token en Requests Autenticadas

Una vez obtenido el token JWT, debe incluirse en todas las solicitudes autenticadas:

```bash
curl -X GET "http://localhost:8001/api/users/me" \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGci..."
```

### 4. Control de Sesiones JWT

El sistema implementa control de sesiones basado en tokens JWT con:

- **Expiraci√≥n autom√°tica**: Los tokens expiran en 3600 segundos (1 hora)
- **Verificaci√≥n de firma**: Cada token es validado criptogr√°ficamente
- **Informaci√≥n de usuario**: El token contiene email y user_id del usuario
- **Renovaci√≥n**: Usar endpoint `/auth/refresh-token` para renovar tokens

#### Verificar Token:
```bash
curl -X POST "http://localhost:8001/api/auth/verify-token" \
  -H "Authorization: Bearer your-jwt-token"
```

#### Renovar Token:
```bash
curl -X POST "http://localhost:8001/api/auth/refresh-token" \
  -H "Authorization: Bearer your-current-token"
```

## Integraci√≥n con Backend Principal

El backend principal puede verificar tokens usando:

```python
from auth_middleware import auth_middleware
from fastapi import Depends
from fastapi.security import HTTPBearer

security = HTTPBearer()

@app.get("/protected-endpoint")
async def protected_route(
    current_user: dict = Depends(
        lambda creds=Depends(security): auth_middleware.get_current_user(creds)
    )
):
    return {"message": "Acceso autorizado", "user": current_user}
```

## Variables de Entorno

- `JWT_SECRET_KEY`: Clave secreta para JWT (CAMBIAR EN PRODUCCI√ìN)
- `DATABASE_URL`: URL de conexi√≥n a PostgreSQL
- `PORT`: Puerto del servicio (default: 8001)

## Ejecuci√≥n Local

```bash
# Instalar dependencias
pip install -r requirements.txt

# Ejecutar servicio
uvicorn main:app --host 0.0.0.0 --port 8001 --reload
```

## Scripts de Prueba

El servicio incluye varios scripts para validar la funcionalidad:

```bash
# Flujo completo de registro y login
python test_auth.py

# Validaciones de errores (contrase√±as no coincidentes, email duplicado)
python test_validation_errors.py

# Pruebas espec√≠ficas del sistema de login
python test_login.py
```

## Ejecuci√≥n con Docker

```bash
# Construir imagen
docker build -t auth-service .

# Ejecutar contenedor
docker run -p 8001:8001 -e JWT_SECRET_KEY=mi-clave-secreta auth-service
```

## Documentaci√≥n API

Una vez ejecutando el servicio, la documentaci√≥n interactiva est√° disponible en:
- Swagger UI: http://localhost:8001/docs
- ReDoc: http://localhost:8001/redoc

## Seguridad

- Contrase√±as hasheadas con bcrypt
- Tokens JWT con expiraci√≥n configurable
- Validaci√≥n de datos con Pydantic
- CORS configurado apropiadamente

## Pr√≥ximas Mejoras

- [ ] Integraci√≥n con base de datos PostgreSQL real
- [ ] Refresh tokens con rotaci√≥n
- [ ] Rate limiting para endpoints
- [ ] Roles y permisos de usuario
- [ ] Autenticaci√≥n OAuth2 (Google, GitHub)
- [ ] Logs estructurados
- [ ] M√©tricas de Prometheus