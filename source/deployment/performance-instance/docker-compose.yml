version: '3.8'

# ============================================
# Docker Compose para Performance Testing con AWS SQS
# ============================================
# Este archivo configura el entorno de pruebas de carga
# que se conecta directamente a AWS SQS (sin Redis ni SSH tunnel)
#
# Servicios incluidos:
# - setup-jwt: Configura JWT token para pruebas de JMeter
# - renew-jwt: Renueva el token JWT automáticamente
# - jmeter: Herramienta para pruebas de carga web
# - producer: Script para generar tareas y enviarlas a SQS
#
# Servicios REMOVIDOS (ya no necesarios):
# - Prometheus: Métricas ahora se envían a CloudWatch
# - Grafana: Visualización ahora se hace en CloudWatch Dashboards
# - Redis: Reemplazado por AWS SQS
# - SSH Tunnel: Ya no es necesario, misma cuenta AWS
# ============================================

services:
  # ===== JWT SETUP (Una sola vez) =====
  setup-jwt:
    build:
      context: ../../performance-testing
      dockerfile: Dockerfile.setup
    container_name: setup-jwt
    env_file:
      - .env
    environment:
      - API_BASE_URL=${API_BASE_URL}
      - TEST_USER_EMAIL=${TEST_USER_EMAIL}
      - TEST_USER_PASSWORD=${TEST_USER_PASSWORD}
    volumes:
      - ../../performance-testing/web-api-tests/scenarios/scenarios:/scripts
    networks:
      - performance-network
    restart: "no"

  # ===== JWT RENEWAL (Cada 30 minutos) =====
  renew-jwt:
    build:
      context: ../../performance-testing
      dockerfile: Dockerfile.setup
    container_name: renew-jwt
    command: ["/app/renew_jwt.py"]
    env_file:
      - .env
    environment:
      - API_BASE_URL=${API_BASE_URL}
      - TEST_USER_EMAIL=${TEST_USER_EMAIL}
      - TEST_USER_PASSWORD=${TEST_USER_PASSWORD}
      - RENEWAL_INTERVAL=1800  # 30 minutos
    volumes:
      - ../../performance-testing/web-api-tests/scenarios/scenarios:/scripts
    networks:
      - performance-network
    depends_on:
      setup-jwt:
        condition: service_completed_successfully
    restart: unless-stopped

  # ===== JMETER (Pruebas de carga web) =====
  jmeter:
    image: justb4/jmeter:latest
    container_name: jmeter
    volumes:
      - ../../performance-testing/web-api-tests/scenarios/scenarios:/scripts
    networks:
      - performance-network
    depends_on:
      setup-jwt:
        condition: service_completed_successfully
    entrypoint: tail -f /dev/null

  # ===== PRODUCER (Envía tareas a AWS SQS) =====
  producer:
    build:
      context: ../../performance-testing/worker-tests
      dockerfile: Dockerfile
    container_name: producer
    env_file:
      - .env
    environment:
      # AWS SQS Configuration
      - USE_SQS=${USE_SQS:-true}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - SQS_DLQ_URL=${SQS_DLQ_URL}
      # AWS S3 Configuration
      - USE_S3=${USE_S3:-true}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      # AWS Credentials (para AWS Academy o EC2 sin IAM Role)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
    volumes:
      - ../../performance-testing/worker-tests/assets:/app/assets
    networks:
      - performance-network
    entrypoint: tail -f /dev/null

networks:
  performance-network:
    driver: bridge

# ============================================
# NOTAS DE USO:
# ============================================
# 1. Configurar .env con las credenciales de AWS y URLs de SQS
# 2. Levantar servicios: docker-compose up -d
# 3. Ejecutar pruebas web (JMeter):
#    docker exec -it jmeter jmeter -n -t /scripts/your_test.jmx
# 4. Ejecutar pruebas de worker (Producer):
#    docker exec -it producer python producer.py --num-videos 100 --no-wait
# 5. Monitorear en CloudWatch:
#    - Logs: /aws/ec2/anb-backend y /aws/ec2/anb-worker
#    - Métricas: ANB/Backend y ANB/Worker
# ============================================
