version: '3.8'

# ============================================
# Docker Compose para Backend con AWS SQS
# ============================================
# Este archivo es para usar cuando migres a AWS SQS
# Ya NO incluye Redis (SQS es el message broker)
#
# Uso:
#   docker-compose -f docker-compose.sqs.yml up -d
#
# O renombrar este archivo a docker-compose.yml después de migrar
# ============================================

services:
  # ===== NGINX API GATEWAY =====
  nginx:
    image: nginx:alpine
    container_name: anb-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===== BACKEND API (Sin Redis - usa AWS SQS) =====
  backend:
    build:
      context: ../..
      dockerfile: backend/Dockerfile
    container_name: anb-backend
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Asegurar que USE_SQS esté activado
      - USE_SQS=true
      # TEST_MODE: true = no envía a cola (para pruebas), false = funcionamiento normal
      - TEST_MODE=${TEST_MODE}
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # ===== CLOUDWATCH LOGS - Auto Scaling Compatible =====
    logging:
      driver: awslogs
      options:
        awslogs-region: us-east-1
        awslogs-group: /aws/ec2/anb-backend
        # awslogs-stream usa el container name (único por instancia EC2)
        # Si hay múltiples instancias, cada una tiene su propio contenedor
        awslogs-stream: backend-${HOSTNAME}
        awslogs-create-group: "true"
        # Modo non-blocking para no afectar performance si CloudWatch está lento
        mode: non-blocking
        max-buffer-size: 25m

networks:
  app-network:
    name: anb-network
    driver: bridge

# ============================================
# NOTAS:
# ============================================
# 1. Redis ha sido REMOVIDO - AWS SQS es el message broker
# 2. Asegurar que USE_SQS=true en .env
# 3. Configurar SQS_QUEUE_URL y SQS_DLQ_URL en .env
# 4. Instance Profile debe estar adjunto a la instancia EC2
# 5. No hay volúmenes de Redis - SQS persiste mensajes automáticamente
# 6. TEST_MODE=false (producción) o TEST_MODE=true (testing sin cola)
#    - false: El backend envía tareas a SQS normalmente
#    - true: El backend NO envía tareas a SQS (para pruebas de carga)
# ============================================
